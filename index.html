<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ONE MUSIC - NEW UI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        :root { --primary: #1DB954; --bg: #0b0b0d; --card: #18181b; --text: #ffffff; --red: #ff4444; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; position: sticky; top: 0; background: rgba(11, 11, 13, 0.9); backdrop-filter: blur(15px); z-index: 1000; border-bottom: 1px solid #27272a; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; object-fit: cover; }
        .brand-name { color: var(--primary); font-weight: 800; letter-spacing: 1px; margin: 0; font-size: 1.2rem; }

        /* Main Container */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        /* Search Box - Improved */
        .search-wrapper { position: sticky; top: 70px; z-index: 900; background: var(--bg); padding-bottom: 15px; }
        .search-input { width: 100%; padding: 15px 20px; border-radius: 12px; border: 1px solid #333; background: #1a1a1a; color: white; font-size: 1rem; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 10px rgba(29, 185, 84, 0.2); }

        /* Song List Style */
        .track-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .track-card { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 15px; background: #121214; border: 1px solid #1f1f22; cursor: pointer; transition: 0.2s; }
        .track-card:hover { background: #1c1c1f; transform: scale(1.02); }
        .track-card img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; }
        .track-info { flex: 1; overflow: hidden; }
        .track-info b { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.05rem; }
        .track-info small { color: #888; display: flex; align-items: center; gap: 8px; margin-top: 4px; }

        /* Overlays (Settings, Profile, Player) */
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; overflow-y: auto; }
        .close-btn { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; color: #888; cursor: pointer; z-index: 10; }

        /* Full Player */
        .player-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: linear-gradient(180deg, #222 0%, #0b0b0d 100%); }
        #fp-img { width: 85%; max-width: 320px; aspect-ratio: 1/1; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); object-fit: cover; }
        .player-meta { width: 100%; margin-top: 30px; }
        .seek-bar { width: 100%; margin: 25px 0; accent-color: var(--primary); cursor: pointer; }
        .player-controls { display: flex; align-items: center; gap: 40px; margin-bottom: 30px; }
        .play-btn { font-size: 5rem; color: var(--primary); }

        /* Buttons */
        .btn { padding: 14px 25px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; width: 100%; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-outline { background: transparent; border: 1px solid #333; color: white; margin-top: 10px; }
        .btn-danger { background: rgba(255, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); margin-top: 20px; }

        .hidden { display: none !important; }
        .live-badge { background: #ff0000; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <img id="my-avatar" class="user-avatar" src="" onclick="openProfile('self')">
        <h3 class="brand-name">A ONE MUSIC</h3>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div style="background: #1a1a1a; padding: 6px 12px; border-radius: 20px; border: 1px solid #333; display: flex; align-items: center; gap: 8px;">
                <span class="live-badge">LIVE</span> <span id="online-users" style="font-size: 0.9rem;">0</span>
            </div>
            <i class="fas fa-cog" style="font-size: 1.4rem; color: #888; cursor: pointer;" onclick="toggleUI('settings-ui', true)"></i>
        </div>
    </div>

    <div class="container">
        <div id="auth-box" style="margin-top: 50px; background: #18181b; padding: 30px; border-radius: 20px; border: 1px solid #27272a;">
            <h2 style="text-align: center; margin-bottom: 25px;">Welcome to A ONE</h2>
            <input type="email" id="a-email" placeholder="Email Address" class="search-input" style="margin-bottom: 15px;">
            <input type="password" id="a-pass" placeholder="Password" class="search-input" style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="authAction()">Continue</button>
        </div>

        <div id="app-box" class="hidden">
            <div class="search-wrapper">
                <input type="text" id="search" placeholder="Search for songs or artists..." class="search-input" oninput="filter()">
            </div>
            <div id="track-list" class="track-list">
                </div>
        </div>
    </div>

    <div id="full-player-ui" class="overlay">
        <i class="fas fa-chevron-down close-btn" onclick="toggleUI('full-player-ui', false)"></i>
        <div class="player-container">
            <img id="fp-img" src="">
            <div class="player-meta">
                <h2 id="fp-title" style="margin: 0;"></h2>
                <p id="fp-art" style="color: #b3b3b3; margin: 10px 0;"></p>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
                    <span style="color: #888;"><i class="far fa-eye"></i> <span id="fp-views">0</span></span>
                    <div style="display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="handleLike()">
                        <span id="fp-likes-count" style="font-weight: bold;">0</span>
                        <i class="far fa-heart" id="fp-like-btn" style="font-size: 1.8rem;"></i>
                    </div>
                </div>

                <input type="range" id="fp-seek" class="seek-bar" value="0">
                
                <div class="player-controls">
                    <i class="fas fa-play-circle play-btn" id="fp-play" onclick="togglePlay()"></i>
                </div>

                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; display: flex; align-items: center; justify-content: space-between;">
                    <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="openProfile(viewUid)">
                        <img id="fp-up-img" style="width: 45px; height: 45px; border-radius: 50%;">
                        <b id="fp-up-name"></b>
                    </div>
                    <button id="fp-fol-btn" class="btn btn-primary" style="width: auto; padding: 8px 15px; font-size: 0.8rem;" onclick="handleFollow()">Follow</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-ui" class="overlay">
        <i class="fas fa-times close-btn" onclick="toggleUI('settings-ui', false)"></i>
        <div class="container" style="padding-top: 60px;">
            <h2 style="margin-bottom: 30px;">Settings</h2>
            
            <div style="background: #18181b; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h4 style="margin-top: 0; color: var(--primary);">Upload New Music</h4>
                <input type="text" id="s-title" placeholder="Song Title" class="search-input" style="margin-bottom: 10px;">
                <input type="text" id="s-artist" placeholder="Artist Name" class="search-input" style="margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn btn-outline" onclick="pick('l')">Select Logo</button>
                    <button class="btn btn-outline" onclick="pick('s')">Select Audio</button>
                </div>
                <button id="pub-btn" class="btn btn-primary" style="display:none; margin-top: 15px;" onclick="publish()">Publish Track</button>
            </div>

            <button class="btn btn-outline" onclick="logout()" style="color: #888;">Logout Account</button>
            <button class="btn btn-danger" onclick="deleteAccount()">Delete Account Permanently</button>
        </div>
    </div>

    <div id="profile-ui" class="overlay">
        <i class="fas fa-arrow-left close-btn" onclick="toggleUI('profile-ui', false)"></i>
        <div class="container" style="padding-top: 60px; text-align: center;">
            <img id="view-p-img" style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover;">
            <h2 id="view-p-name" style="margin: 15px 0 5px 0;"></h2>
            <p id="view-p-fol" style="color: #888; margin-bottom: 30px;"></p>
            
            <hr style="border: 0; border-top: 1px solid #27272a; margin-bottom: 25px;">
            <h3 style="text-align: left;">Uploaded Tracks</h3>
            <div id="user-songs" class="track-list"></div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, get, runTransaction, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);
        const audio = document.getElementById('audio-player');
        let tempL = "", tempS = "", songs = [], curId = null, viewUid = null;

        window.toggleUI = (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none';

        onAuthStateChanged(auth, u => {
            if(u){
                toggleUI('auth-box', false); toggleUI('app-box', true);
                document.getElementById('my-avatar').src = u.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                set(ref(rtdb, `online_users/${u.uid}`), true);
                onDisconnect(ref(rtdb, `online_users/${u.uid}`)).remove();
                loadSongs();
            }
        });

        onValue(ref(rtdb, 'online_users'), snap => document.getElementById('online-users').innerText = snap.size || 0);

        window.authAction = async () => {
            const e = document.getElementById('a-email').value, p = document.getElementById('a-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(() => {
                createUserWithEmailAndPassword(auth, e, p).catch(err => alert(err.message));
            });
        };

        function loadSongs() {
            onValue(ref(rtdb, 'songs'), snap => {
                songs = []; snap.forEach(c => songs.push({id: c.key, ...c.val()}));
                filter();
            });
        }

        window.filter = () => {
            const list = document.getElementById('track-list'); list.innerHTML = "";
            const q = document.getElementById('search').value.toLowerCase();
            songs.filter(s => s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q)).forEach(s => {
                const likes = s.likes ? Object.keys(s.likes).length : 0;
                list.innerHTML += `
                <div class="track-card" onclick="playSong('${s.id}')">
                    <img src="${s.logo}">
                    <div class="track-info">
                        <b>${s.title}</b>
                        <small>${s.artist} • <i class="far fa-heart"></i> ${likes} • <i class="far fa-eye"></i> ${s.views || 0}</small>
                    </div>
                    <i class="fas fa-play-circle" style="color:var(--primary); font-size: 1.5rem;"></i>
                </div>`;
            });
        };

        window.playSong = (id) => {
            curId = id; const s = songs.find(x => x.id === id); viewUid = s.uid;
            document.getElementById('fp-title').innerText = s.title;
            document.getElementById('fp-art').innerText = s.artist;
            document.getElementById('fp-img').src = s.logo;
            document.getElementById('fp-up-img').src = s.up_p || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            document.getElementById('fp-up-name').innerText = s.up || "User";
            
            onValue(ref(rtdb, `songs/${id}/likes`), snap => {
                const count = snap.size || 0;
                document.getElementById('fp-likes-count').innerText = count;
                const liked = snap.hasChild(auth.currentUser.uid);
                const btn = document.getElementById('fp-like-btn');
                btn.className = liked ? "fas fa-heart" : "far fa-heart";
                btn.style.color = liked ? "var(--red)" : "white";
            });

            onValue(ref(rtdb, `songs/${id}/views`), snap => document.getElementById('fp-views').innerText = snap.val() || 0);

            if(audio.src !== s.url) { 
                audio.src = s.url; audio.play(); 
                runTransaction(ref(rtdb, `songs/${id}/views`), v => (v || 0) + 1);
            }
            toggleUI('full-player-ui', true);
            document.getElementById('fp-play').className = "fas fa-pause-circle play-btn";
        };

        window.handleLike = () => {
            const lRef = ref(rtdb, `songs/${curId}/likes/${auth.currentUser.uid}`);
            get(lRef).then(s => s.exists() ? remove(lRef) : set(lRef, true));
        };

        window.openProfile = (uid) => {
            const targetUid = uid === 'self' ? auth.currentUser.uid : uid;
            onValue(ref(rtdb, `users/${targetUid}`), snap => {
                const d = snap.val() || {};
                document.getElementById('view-p-name').innerText = d.up || "User";
                document.getElementById('view-p-img').src = d.up_p || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            });
            const pList = document.getElementById('user-songs'); pList.innerHTML = "";
            songs.filter(s => s.uid === targetUid).forEach(s => {
                pList.innerHTML += `
                <div class="track-card" onclick="playSong('${s.id}')">
                    <img src="${s.logo}">
                    <div class="track-info"><b>${s.title}</b><small>${s.artist}</small></div>
                </div>`;
            });
            toggleUI('profile-ui', true);
        };

        window.pick = (m) => {
            cloudinary.openUploadWidget({cloudName:"dcsczlahu", uploadPreset:"ml_default", resourceType: m==='s'?'video':'image'}, (err, res) => {
                if(!err && res.event === "success"){
                    if(m==='l') tempL = res.info.secure_url;
                    if(m==='s') { tempS = res.info.secure_url; document.getElementById('pub-btn').style.display='block'; }
                }
            });
        };

        window.publish = () => {
            const sData = { title: document.getElementById('s-title').value, artist: document.getElementById('s-artist').value, logo: tempL, url: tempS, uid: auth.currentUser.uid, up: auth.currentUser.displayName || "User", up_p: auth.currentUser.photoURL || "", views: 0 };
            push(ref(rtdb, 'songs'), sData);
            set(ref(rtdb, `users/${auth.currentUser.uid}/up`), auth.currentUser.displayName || "User");
            set(ref(rtdb, `users/${auth.currentUser.uid}/up_p`), auth.currentUser.photoURL || "");
            toggleUI('settings-ui', false);
        };

        window.deleteAccount = async () => {
            if(confirm("നിങ്ങളുടെ അക്കൗണ്ട് സ്ഥിരമായി ഡിലീറ്റ് ചെയ്യണോ?")) {
                try {
                    await remove(ref(rtdb, `users/${auth.currentUser.uid}`));
                    await deleteUser(auth.currentUser);
                    location.reload();
                } catch (e) { alert("വീണ്ടും ലോഗിൻ ചെയ്ത ശേഷം ശ്രമിക്കുക."); }
            }
        };

        window.togglePlay = () => {
            if(audio.paused) { audio.play(); document.getElementById('fp-play').className="fas fa-pause-circle play-btn"; }
            else { audio.pause(); document.getElementById('fp-play').className="fas fa-play-circle play-btn"; }
        };

        audio.ontimeupdate = () => { 
            const seek = document.getElementById('fp-seek');
            seek.max = audio.duration || 0; 
            seek.value = audio.currentTime; 
        };
        document.getElementById('fp-seek').oninput = (e) => audio.currentTime = e.target.value;
        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
