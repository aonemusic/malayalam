<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ONE MUSIC - PRO EDIT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        :root { --primary: #1DB954; --bg: #0b0b0d; --card: #18181b; --text: #ffffff; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; position: sticky; top: 0; background: rgba(11, 11, 13, 0.9); backdrop-filter: blur(15px); z-index: 1000; border-bottom: 1px solid #27272a; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); cursor: pointer; object-fit: cover; }
        
        /* Layout Fixes */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .search-input { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #1a1a1a; color: white; font-size: 1rem; }

        /* Song List - Vertical Only */
        .track-list { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .track-card { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 15px; background: #121214; border: 1px solid #1f1f22; cursor: pointer; width: 100%; }
        .track-card img { width: 60px; height: 60px; border-radius: 10px; object-fit: cover; }
        .track-info { flex: 1; }

        /* Overlays */
        .overlay { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 40px; }
        .close-btn { font-size: 1.5rem; color: #888; cursor: pointer; padding: 20px; }

        /* Profile Section */
        .profile-header { text-align: center; padding: 20px; position: relative; }
        .p-img-container { position: relative; width: 120px; height: 120px; margin: 0 auto; }
        .p-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; }
        .edit-badge { position: absolute; bottom: 5px; right: 5px; background: var(--primary); color: black; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 0.8rem; }

        .btn { padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: black; }
        .btn-dark { background: #27272a; color: white; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="header">
        <img id="my-avatar" class="user-avatar" src="" onclick="openProfile('self')">
        <h3 style="color: var(--primary); margin:0;">A ONE MUSIC</h3>
        <i class="fas fa-cog" style="font-size: 1.2rem; color: #888; cursor: pointer;" onclick="toggleUI('settings-ui', true)"></i>
    </div>

    <div class="container">
        <div id="auth-box" style="background: #18181b; padding: 30px; border-radius: 20px; border: 1px solid #27272a;">
            <h2 style="text-align: center;">Login</h2>
            <input type="email" id="a-email" placeholder="Email" class="search-input" style="margin-bottom: 10px;">
            <input type="password" id="a-pass" placeholder="Password" class="search-input" style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="authAction()">Continue</button>
        </div>

        <div id="app-box" class="hidden">
            <input type="text" id="search" placeholder="Search songs..." class="search-input" oninput="filter()">
            <div id="track-list" class="track-list"></div>
        </div>
    </div>

    <div id="profile-ui" class="overlay">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <i class="fas fa-arrow-left close-btn" onclick="toggleUI('profile-ui', false)"></i>
            <h3 id="p-title-head">Profile</h3>
            <div style="width:50px;"></div>
        </div>
        
        <div class="profile-header">
            <div class="p-img-container">
                <img id="view-p-img" class="p-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
                <div id="edit-icon" class="edit-badge hidden" onclick="toggleUI('edit-profile-ui', true)">
                    <i class="fas fa-pen"></i>
                </div>
            </div>
            <h2 id="view-p-name" style="margin: 15px 0 5px 0;">User</h2>
            <p id="view-p-fol" style="color: #888;"></p>
        </div>

        <div class="container">
            <h4 style="border-bottom: 1px solid #27272a; padding-bottom: 10px;">Uploaded Tracks</h4>
            <div id="user-songs" class="track-list"></div>
        </div>
    </div>

    <div id="edit-profile-ui" class="overlay" style="background: rgba(0,0,0,0.9); justify-content: center;">
        <div class="container" style="background: #18181b; border-radius: 20px; padding: 30px;">
            <h3>Edit Profile</h3>
            <button class="btn btn-dark" onclick="pick('p')">Change Photo</button>
            <input type="text" id="new-name" placeholder="New Username" class="search-input" style="margin-top: 15px;">
            <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            <button class="btn btn-dark" onclick="toggleUI('edit-profile-ui', false)">Cancel</button>
        </div>
    </div>

    <div id="settings-ui" class="overlay">
        <i class="fas fa-times close-btn" onclick="toggleUI('settings-ui', false)"></i>
        <div class="container">
            <h3>Settings</h3>
            <button class="btn btn-dark" onclick="logout()">Logout</button>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);
        let songs = [], tempP = "";

        window.toggleUI = (id, show) => document.getElementById(id).style.display = show ? 'flex' : 'none';

        onAuthStateChanged(auth, u => {
            if(u){
                toggleUI('auth-box', false); toggleUI('app-box', true);
                document.getElementById('my-avatar').src = u.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                loadSongs();
            }
        });

        window.authAction = () => {
            const e = document.getElementById('a-email').value, p = document.getElementById('a-pass').value;
            signInWithEmailAndPassword(auth, e, p).catch(() => createUserWithEmailAndPassword(auth, e, p));
        };

        function loadSongs() {
            onValue(ref(rtdb, 'songs'), snap => {
                songs = []; snap.forEach(c => songs.push({id: c.key, ...c.val()}));
                filter();
            });
        }

        window.filter = () => {
            const list = document.getElementById('track-list'); list.innerHTML = "";
            songs.forEach(s => {
                list.innerHTML += `
                <div class="track-card">
                    <img src="${s.logo}">
                    <div class="track-info"><b>${s.title}</b><br><small>${s.artist}</small></div>
                </div>`;
            });
        };

        window.openProfile = (uid) => {
            const targetUid = uid === 'self' ? auth.currentUser.uid : uid;
            const isMe = targetUid === auth.currentUser.uid;
            
            document.getElementById('edit-icon').classList.toggle('hidden', !isMe);
            
            onValue(ref(rtdb, `users/${targetUid}`), snap => {
                const d = snap.val() || {};
                document.getElementById('view-p-name').innerText = d.up || "User";
                document.getElementById('view-p-img').src = d.up_p || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
            });

            const pList = document.getElementById('user-songs'); pList.innerHTML = "";
            songs.filter(s => s.uid === targetUid).forEach(s => {
                pList.innerHTML += `<div class="track-card"><img src="${s.logo}"><b>${s.title}</b></div>`;
            });
            toggleUI('profile-ui', true);
        };

        window.pick = (type) => {
            cloudinary.openUploadWidget({cloudName:"dcsczlahu", uploadPreset:"ml_default"}, (err, res) => {
                if(!err && res.event === "success") tempP = res.info.secure_url;
            });
        };

        window.saveProfile = async () => {
            const name = document.getElementById('new-name').value;
            const user = auth.currentUser;
            const updates = {};
            if(name) updates[`users/${user.uid}/up`] = name;
            if(tempP) updates[`users/${user.uid}/up_p`] = tempP;

            await update(ref(rtdb), updates);
            await updateProfile(user, { displayName: name || user.displayName, photoURL: tempP || user.photoURL });
            
            alert("Profile Updated!");
            location.reload();
        };

        window.logout = () => signOut(auth).then(() => location.reload());
    </script>
</body>
</html>
