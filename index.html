<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A ONE MUSIC - Premium Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <style>
        :root { --primary: #007bff; --glass: rgba(255, 255, 255, 0.1); --border: rgba(255, 255, 255, 0.2); --success: #28a745; }
        body { font-family: 'Poppins', sans-serif; background: #0f0f12; color: white; margin: 0; padding: 20px; text-align: center; }
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid var(--border); padding: 20px; border-radius: 15px; max-width: 400px; margin: 0 auto 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; background: rgba(255,255,255,0.05); color: white; box-sizing: border-box; outline: none; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; margin-bottom: 10px; }
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--success); color: white; border: none; font-size: 24px; cursor: pointer; }
        #upload-form { display: none; margin-top: 15px; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .box { background: var(--glass); padding: 20px; border-radius: 15px; width: 350px; border: 1px solid var(--border); }
        .track-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .track-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .hidden { display: none; }
        
        /* Player Stats Styling */
        .player-stats { display: flex; justify-content: space-around; align-items: center; margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 10px; }
        .like-btn-player { cursor: pointer; transition: 0.3s; font-size: 1.2em; }
        .like-btn-player.liked { color: #ff4757; }
        .view-stat { color: #aaa; font-size: 0.9em; }
    </style>
</head>
<body>

    <h1>A ONE MUSIC âœ“</h1>

    <div id="auth-section" class="card">
        <h3>Login / Sign Up</h3>
        <input type="text" id="auth-username" placeholder="Full Name">
        <input type="email" id="auth-email" placeholder="Email">
        <input type="password" id="auth-password" placeholder="Password">
        <button class="btn" onclick="handleAuth()">Continue</button>
    </div>

    <div id="app-content" class="hidden">
        <div class="card" style="display:flex; justify-content: space-between; align-items: center; padding: 10px 20px;">
            <b id="user-welcome"></b>
            <button onclick="logout()" style="background:none; border:none; color:#ff4d4d; cursor:pointer;">Logout</button>
        </div>

        <div style="margin-bottom: 30px;">
            <button class="fab-btn" onclick="toggleUploadForm()"><i class="fas fa-plus"></i></button>
            <div id="upload-form" class="card">
                <h4><i class="fas fa-upload"></i> New Song</h4>
                <input type="text" id="song-name" placeholder="Song Name">
                <input type="text" id="singer-name" placeholder="Singer Name">
                <button class="btn" style="background: #6c757d;" onclick="pickFile('image')"><i class="fas fa-image"></i> Choose Logo</button>
                <button class="btn" style="background: #6c757d;" onclick="pickFile('video')"><i class="fas fa-file-audio"></i> Choose Music</button>
                <button id="publish-btn" class="btn" style="background:var(--success); display: none;" onclick="saveSongData()">Publish Song</button>
            </div>
        </div>

        <div class="container">
            <div class="box">
                <h3>Global Playlist ðŸ’¿</h3>
                <div id="track-list"></div>
            </div>

            <div class="box" id="music-player-box">
                <img id="player-img" src="songlogo.jpg" style="width: 100%; border-radius: 15px; max-height: 250px; object-fit: cover;">
                <h4 id="player-title" style="margin: 15px 0 5px;">Select a song</h4>
                <p id="player-artist" style="color: #bbb; font-size: 0.85em;"></p>
                
                <div class="player-stats">
                    <div class="view-stat"><i class="fas fa-eye"></i> <span id="view-count">0</span></div>
                    <div class="like-btn-player" id="main-like-btn" onclick="handleLike()">
                        <i class="fas fa-heart"></i> <span id="like-count">0</span>
                    </div>
                </div>

                <audio id="audio-player" controls style="width: 100%;"></audio>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAthFMO8zGT5BtiOkh4zkc71jL06LR_F9c",
            authDomain: "a-one-chat-19ad6.firebaseapp.com",
            databaseURL: "https://a-one-chat-19ad6-default-rtdb.firebaseio.com",
            projectId: "a-one-chat-19ad6",
            storageBucket: "a-one-chat-19ad6.firebasestorage.app",
            messagingSenderId: "691783470864",
            appId: "1:691783470864:web:0b119fcddf984af66e5f95"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const rtdb = getDatabase(app);

        let songUrl = "", logoUrl = "songlogo.jpg", currentSongId = null, songList = [];

        window.handleAuth = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-username').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(cred.user, { displayName: name });
            } catch (e) { signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message)); }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('user-welcome').innerText = "Hi, " + user.displayName;
                loadSongs();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        window.logout = () => signOut(auth);
        window.toggleUploadForm = () => {
            const form = document.getElementById('upload-form');
            form.style.display = form.style.display === "block" ? "none" : "block";
        };

        window.pickFile = (type) => {
            cloudinary.openUploadWidget({ cloudName: "dcsczlahu", uploadPreset: "ml_default", resourceType: type }, (err, res) => {
                if (!err && res.event === "success") {
                    if (type === 'image') logoUrl = res.info.secure_url;
                    else songUrl = res.info.secure_url;
                    if (songUrl) document.getElementById('publish-btn').style.display = "block";
                }
            });
        };

        window.saveSongData = () => {
            const name = document.getElementById('song-name').value;
            const artist = document.getElementById('singer-name').value;
            if(!name || !artist || !songUrl) return alert("Fill all details!");
            push(ref(rtdb, 'songs'), { title: name, artist: artist, logo: logoUrl, url: songUrl, uploader: auth.currentUser.displayName, views: 0, likes: {} })
            .then(() => location.reload());
        };

        function loadSongs() {
            onValue(ref(rtdb, 'songs'), (snap) => {
                const list = document.getElementById('track-list');
                list.innerHTML = ""; songList = [];
                snap.forEach((child) => {
                    const song = child.val();
                    const songId = child.key;
                    songList.push({ id: songId, ...song });
                    list.innerHTML += `
                        <div class="track-item" onclick="playSong('${songId}')">
                            <img src="${song.logo}" onerror="this.src='songlogo.jpg'">
                            <div style="text-align:left"><strong>${song.title}</strong><br><small>${song.artist}</small></div>
                        </div>`;
                });
            });
        }

        window.playSong = (id) => {
            currentSongId = id;
            const songRef = ref(rtdb, `songs/${id}`);
            onValue(songRef, (snap) => {
                const song = snap.val();
                if(!song) return;
                document.getElementById('player-title').innerText = song.title;
                document.getElementById('player-artist').innerText = song.artist;
                document.getElementById('player-img').src = song.logo;
                document.getElementById('view-count').innerText = song.views || 0;
                
                const likes = song.likes || {};
                document.getElementById('like-count').innerText = Object.keys(likes).length;
                
                const likeBtn = document.getElementById('main-like-btn');
                if (likes[auth.currentUser.uid]) likeBtn.classList.add('liked');
                else likeBtn.classList.remove('liked');

                const audio = document.getElementById('audio-player');
                if(audio.src !== song.url) {
                    audio.src = song.url;
                    audio.play();
                    // Increment Views
                    runTransaction(ref(rtdb, `songs/${id}/views`), (v) => (v || 0) + 1);
                }
            });
        };

        // Auto Play Next Song Logic
        document.getElementById('audio-player').onended = () => {
            let currentIndex = songList.findIndex(s => s.id === currentSongId);
            if (currentIndex !== -1 && currentIndex < songList.length - 1) {
                playSong(songList[currentIndex + 1].id);
            }
        };

        // Like Logic
        window.handleLike = () => {
            if(!currentSongId) return;
            const uid = auth.currentUser.uid;
            const likeRef = ref(rtdb, `songs/${currentSongId}/likes/${uid}`);
            
            get(likeRef).then((snap) => {
                if (snap.exists()) set(likeRef, null); // Unlike
                else set(likeRef, true); // Like
            });
        };

    </script>
</body>
</html>
